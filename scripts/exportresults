(() => {
  // ðŸ”¥ Acessa o estado real do React (ExamContext)
  const reactRoot = document.querySelector("#root");
  if (!reactRoot) {
    console.error("âŒ Root nÃ£o encontrado");
    return;
  }

  // Hack seguro: pegar o estado renderizado pelo ReviewPage
  // Usamos a ordem das questions renderizadas
  const results = [];

  const reviewBlocks = document.querySelectorAll(".review-answer");

  // âš ï¸ IMPORTANTE:
  // answers NÃƒO estÃ¡ no DOM â†’ precisamos inferir via render
  // O ReviewPage jÃ¡ renderiza na mesma ordem de `questions`
  const examState =
    window.__REACT_DEVTOOLS_GLOBAL_HOOK__ &&
    [...document.querySelectorAll("*")]
      .find(el => el.__reactFiber$ || el.__reactInternalInstance$);

  // Fallback: inferir answers pelo HTML renderizado
  reviewBlocks.forEach((block, index) => {
    const questionText =
      block.querySelector(".que p")?.innerText || "";

    const domain =
      block
        .querySelector(".que-category")
        ?.innerText.replace("Domain:", "")
        .trim() || null;

    const options = {};
    let correctAnswer = null;
    let yourAnswer = null;

    block.querySelectorAll(".answer li").forEach(li => {
      const raw = li.innerText
        .replace(/\s+(right|wrong)$/i, "")
        .trim();

      const key = raw.charAt(0);
      const value = raw.slice(3).trim();

      options[key] = value;

      if (li.classList.contains("right")) {
        correctAnswer = key;
      }

      if (li.classList.contains("selected")) {
        yourAnswer = key;
      }
    });

    // âœ… REGRA FINAL:
    // - se marcou algo â†’ yourAnswer = letra
    // - se nÃ£o marcou â†’ yourAnswer = null
    const isCorrect =
      yourAnswer !== null && yourAnswer === correctAnswer;

    const explanations = [];
    block
      .querySelectorAll(".explanation-block ul li")
      .forEach(li => explanations.push(li.innerText.trim()));

    results.push({
      index: index + 1,
      domain,
      question: questionText,
      options,
      yourAnswer,
      correctAnswer,
      isCorrect,
      explanations
    });
  });

  // ðŸ“¦ Download
  const blob = new Blob(
    [JSON.stringify(results, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "gcp-review-export.json";
  a.click();
  URL.revokeObjectURL(url);

  console.log("âœ… Export final concluÃ­do com sucesso!", results);
})();
